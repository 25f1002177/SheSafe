{% extends "base.html" %}

{% block title %}{{ vendor.business_name }} - SheSafe{% endblock %}

{% block content %}
<div
    class="relative flex min-h-screen w-full flex-col overflow-x-hidden pb-32 max-w-[430px] mx-auto bg-white dark:bg-background-dark">
    <!-- Header Image -->
    <div class="relative h-72 w-full overflow-hidden shrink-0">
        <div class="absolute inset-0 bg-slate-900/20 z-10"></div>
        <img class="h-full w-full object-cover"
            src="{% if vendor.images %}{{ vendor.images[0].url }}{% else %}https://images.unsplash.com/photo-1542314831-068cd1dbfeeb?auto=format&fit=crop&q=80&w=2070{% endif %}"
            alt="{{ vendor.business_name }}">

        <!-- Top Controls -->
        <div class="absolute top-6 left-5 z-20 flex w-[calc(100%-40px)] justify-between items-center">
            <a href="{{ url_for('main.index') }}"
                class="flex size-10 items-center justify-center rounded-full bg-white/20 backdrop-blur-md text-white border border-white/30">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <div class="flex gap-2">
                <button
                    class="flex size-10 items-center justify-center rounded-full bg-white/20 backdrop-blur-md text-white border border-white/30">
                    <span class="material-symbols-outlined">share</span>
                </button>
                <button
                    class="flex size-10 items-center justify-center rounded-full bg-white/20 backdrop-blur-md text-white border border-white/30">
                    <span class="material-symbols-outlined">favorite</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Content Card (Overlapping) -->
    <div class="relative -mt-8 w-full rounded-t-[32px] bg-white dark:bg-background-dark px-5 pt-8 pb-5 z-20">
        <div class="flex justify-between items-start mb-4">
            <div>
                <div class="flex items-center gap-2 mb-1.5">
                    <h1 class="text-navy-trust dark:text-white text-2xl font-black leading-tight">{{
                        vendor.business_name }}</h1>
                    {% if vendor.is_verified %}
                    <span class="text-brand-pink">
                        <span class="material-symbols-outlined fill-1 text-xl">verified</span>
                    </span>
                    {% endif %}
                </div>
                <div class="flex items-center gap-1.5 text-slate-400">
                    <span class="material-symbols-outlined text-sm">location_on</span>
                    <span class="text-xs font-medium">{{ vendor.address }}</span>
                </div>
            </div>
            <div class="bg-navy-trust/5 dark:bg-slate-800 rounded-2xl p-2 px-3 flex flex-col items-center">
                <div class="flex items-center gap-1 text-brand-pink">
                    <span class="material-symbols-outlined text-sm fill-1">star</span>
                    <span class="text-sm font-bold">{{ "%.1f"|format(vendor.average_rating) }}</span>
                </div>
                <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Rating</span>
            </div>
        </div>

        <div class="flex gap-4 border-y border-slate-50 dark:border-slate-800 py-5 my-6 overflow-x-auto no-scrollbar">
            <div class="flex flex-col items-center gap-1.5 min-w-[70px]">
                <div class="size-10 bg-brand-pink/5 rounded-full flex items-center justify-center text-brand-pink">
                    <span class="material-symbols-outlined">schedule</span>
                </div>
                <span class="text-[10px] font-bold text-navy-trust dark:text-slate-400">24/7 Access</span>
            </div>
            {% if vendor.has_cctv %}
            <div class="flex flex-col items-center gap-1.5 min-w-[70px]">
                <div class="size-10 bg-brand-pink/5 rounded-full flex items-center justify-center text-brand-pink">
                    <span class="material-symbols-outlined">videocam</span>
                </div>
                <span class="text-[10px] font-bold text-navy-trust dark:text-slate-400">CCTV Secure</span>
            </div>
            {% endif %}
            {% if vendor.has_female_staff %}
            <div class="flex flex-col items-center gap-1.5 min-w-[70px]">
                <div class="size-10 bg-brand-pink/5 rounded-full flex items-center justify-center text-brand-pink">
                    <span class="material-symbols-outlined">woman</span>
                </div>
                <span class="text-[10px] font-bold text-navy-trust dark:text-slate-400">Female Staff</span>
            </div>
            {% endif %}
            <div class="flex flex-col items-center gap-1.5 min-w-[70px]">
                <div class="size-10 bg-brand-pink/5 rounded-full flex items-center justify-center text-brand-pink">
                    <span class="material-symbols-outlined">clean_hands</span>
                </div>
                <span class="text-[10px] font-bold text-navy-trust dark:text-slate-400">Hygienic</span>
            </div>
        </div>

        <!-- About -->
        <h3 class="text-navy-trust dark:text-white text-lg font-bold mb-3">About Space</h3>
        <p class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed mb-8">
            {{ vendor.description if vendor.description else "This verified SheSafe location provides premium sanitation
            facilities with guaranteed hygiene standards and gender-segregated spaces for your comfort." }}
        </p>

        <!-- Facilities/Services -->
        <h3 class="text-navy-trust dark:text-white text-lg font-bold mb-4">Services Available</h3>
        <div class="grid grid-cols-2 gap-3 mb-8">
            {% set categories = vendor.category.split(', ') %}
            {% for cat in categories %}
            <div
                class="flex items-center gap-3 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-800">
                <span class="material-symbols-outlined text-brand-pink text-xl">
                    {% if cat == 'Washroom' %}wc{% elif cat == 'Period Care' %}sanitizer{% elif cat == 'Nursing Room'
                    %}baby_changing_station{% elif cat == 'Changing Room' %}checkroom{% else %}verified{% endif %}
                </span>
                <span class="text-xs font-bold text-navy-trust dark:text-slate-300">{{ cat }}</span>
            </div>
            {% endfor %}
        </div>

        {% if vendor.images|length > 1 %}
        <!-- Image Gallery -->
        <h3 class="text-navy-trust dark:text-white text-lg font-bold mb-4">Gallery</h3>
        <div class="flex gap-3 overflow-x-auto no-scrollbar pb-8">
            {% for img in vendor.images %}
            <div class="size-24 shrink-0 rounded-2xl overflow-hidden border border-slate-100 dark:border-slate-800">
                <img src="{{ img.url }}" class="w-full h-full object-cover">
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Reviews Section -->
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-navy-trust dark:text-white text-lg font-bold">Reviews</h3>
            <span class="text-brand-pink text-xs font-bold uppercase tracking-wider">Write Review</span>
        </div>

        <div class="space-y-4">
            {% for feedback in vendor.feedbacks[:2] %}
            <div
                class="bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 p-4 rounded-2xl shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <div
                            class="size-8 bg-pink-100 dark:bg-pink-900/30 rounded-full flex items-center justify-center text-brand-pink font-bold text-xs uppercase">
                            {{ feedback.user.name[0] }}
                        </div>
                        <span class="text-xs font-bold text-navy-trust dark:text-white">{{ feedback.user.name
                            }}</span>
                    </div>
                    <div class="flex items-center gap-0.5 text-brand-pink">
                        {% for i in range(feedback.rating|int) %}
                        <span class="material-symbols-outlined text-[10px] fill-1">star</span>
                        {% endfor %}
                    </div>
                </div>
                <p class="text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed italic line-clamp-2">"{{
                    feedback.comment }}"</p>
            </div>
            {% else %}
            <p class="text-xs text-slate-400 italic text-center py-4 bg-slate-50 dark:bg-slate-800 rounded-xl">No
                reviews yet. Be the first to share your experience!</p>
            {% endfor %}
        </div>
    </div>

    <!-- Fixed Action Bar -->
    <div
        class="fixed bottom-0 w-full max-w-[430px] p-5 pb-8 bg-white/90 dark:bg-background-dark/95 backdrop-blur-xl border-t border-slate-100 dark:border-slate-800 flex gap-4 z-[60]">
        <button
            class="flex size-14 items-center justify-center rounded-2xl bg-navy-trust/5 dark:bg-slate-800 text-navy-trust dark:text-white active:scale-95 transition-all">
            <span class="material-symbols-outlined text-2xl">near_me</span>
        </button>
        {% if current_user.is_authenticated %}
        {% if current_user.role == 'user' %}
        <button onclick="openBookingModal()"
            class="flex-1 rounded-2xl bg-navy-trust text-white font-bold text-base shadow-xl shadow-navy-trust/20 active:scale-[0.98] transition-all">
            Reserve Safe Space
        </button>
        {% else %}
        <div
            class="flex-1 flex items-center justify-center rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold text-sm text-center px-4">
            Available for visitors
        </div>
        {% endif %}
        {% else %}
        <a href="{{ url_for('main.login') }}"
            class="flex-1 flex items-center justify-center rounded-2xl bg-brand-pink text-white font-bold text-base shadow-xl shadow-brand-pink/20 active:scale-[0.98] transition-all no-underline">
            Login to Book
        </a>
        {% endif %}
    </div>
</div>

{% if current_user.role == 'user' %}
<!-- Booking Modal -->
<div id="booking-modal" class="fixed inset-0 z-[100] hidden items-end justify-center bg-black/40 backdrop-blur-sm p-4">
    <div
        class="w-full max-w-[400px] rounded-[32px] bg-white dark:bg-background-dark p-6 pb-10 animate-in slide-in-from-bottom duration-300">
        <div class="mx-auto mb-6 h-1.5 w-12 rounded-full bg-slate-200"></div>

        <h3 class="text-navy-trust dark:text-white text-xl font-black mb-1">Pick a Visit Time</h3>
        <p class="text-slate-400 text-sm mb-6">Reservation helps vendors prepare clean spaces for you.</p>

        <form action="{{ url_for('main.book_vendor', vendor_id=vendor.id) }}" method="POST" class="space-y-6">
            <div>
                <label
                    class="text-[10px] font-bold text-navy-trust/50 dark:text-slate-400 uppercase tracking-widest block mb-2">Visit
                    Date & Time</label>
                <input type="datetime-local" name="visit_date" required
                    class="w-full rounded-2xl border-none bg-slate-50 dark:bg-slate-800 p-4 text-sm font-bold text-navy-trust dark:text-white focus:ring-2 focus:ring-brand-pink">
            </div>

            <div>
                <label
                    class="text-[10px] font-bold text-navy-trust/50 dark:text-slate-400 uppercase tracking-widest block mb-2">Payment
                    Mode</label>
                <div class="grid grid-cols-2 gap-3">
                    <label
                        class="relative flex cursor-pointer items-center justify-center rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 text-center transition-all peer-checked:border-brand-pink has-[:checked]:border-brand-pink has-[:checked]:bg-brand-pink/5">
                        <input type="radio" name="payment_mode" value="pay_at_location" checked class="sr-only">
                        <span class="text-xs font-bold text-navy-trust dark:text-white">Pay Later</span>
                    </label>
                    <label
                        class="relative flex cursor-pointer items-center justify-center rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 text-center transition-all has-[:checked]:border-brand-pink has-[:checked]:bg-brand-pink/5">
                        <input type="radio" name="payment_mode" value="app" class="sr-only">
                        <span class="text-xs font-bold text-navy-trust dark:text-white">In-App</span>
                    </label>
                </div>
            </div>

            <input type="hidden" name="amount" value="0">

            <div class="flex gap-3 pt-2">
                <button type="button" onclick="closeBookingModal()"
                    class="flex-1 rounded-2xl bg-slate-100 dark:bg-slate-800 py-4 text-sm font-bold text-navy-trust dark:text-white">Cancel</button>
                <button type="submit"
                    class="flex-1 rounded-2xl bg-brand-pink py-4 text-sm font-bold text-white shadow-lg shadow-brand-pink/20">Confirm</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openBookingModal() {
        const modal = document.getElementById('booking-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    function closeBookingModal() {
        const modal = document.getElementById('booking-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
    // Close on click outside
    document.getElementById('booking-modal').addEventListener('click', function (e) {
        if (e.target === this) closeBookingModal();
    });
</script>
{% endif %}
{% endblock %}